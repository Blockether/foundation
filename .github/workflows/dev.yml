name: Development

on:
  push:
    branches: [ feature/*, fix/*, hotfix/* ]
  pull_request:
    branches: [ feature/*, fix/*, hotfix/* ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  quick-check:
    name: Quick Checks
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.13"

    - name: Cache uv
      uses: actions/cache@v4
      with:
        path: ~/.cache/uv
        key: ${{ runner.os }}-uv-${{ hashFiles('pyproject.toml') }}
        restore-keys: |
          ${{ runner.os }}-uv-

    - name: Set up uv
      uses: astral-sh/setup-uv@v4

    - name: Create virtual environment
      run: uv venv

    - name: Install dependencies
      run: |
        source .venv/bin/activate
        uv pip install -e ".[dev]"

    - name: Quick formatting check
      run: |
        source .venv/bin/activate
        ruff format --check src/ tests/

    - name: Quick linting
      run: |
        source .venv/bin/activate
        ruff check src/ tests/ --select=E,F,I

    - name: Run unit tests only
      run: |
        source .venv/bin/activate
        poe test-unit

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    permissions:
      contents: read

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.13"

    - name: Cache uv
      uses: actions/cache@v4
      with:
        path: ~/.cache/uv
        key: ${{ runner.os }}-uv-${{ hashFiles('pyproject.toml') }}
        restore-keys: |
          ${{ runner.os }}-uv-

    - name: Set up uv
      uses: astral-sh/setup-uv@v4

    - name: Create virtual environment
      run: uv venv

    - name: Install dependencies
      run: |
        source .venv/bin/activate
        uv pip install -e ".[dev]"

    - name: Run integration tests
      env:
        # Add any required environment variables for integration tests
        # Uncomment and configure if needed:
        # OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        # ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        INTEGRATION_TESTS_ENABLED: "true"
      run: |
        source .venv/bin/activate
        if command -v poe &> /dev/null && poe test-integration --help &> /dev/null; then
          poe test-integration
        else
          echo "Integration tests not configured, skipping..."
          exit 0
        fi
